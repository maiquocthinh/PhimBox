<!DOCTYPE html>
<html lang="en">
	<head>
		<%- include('./partials/head') %>
		<link
			rel="stylesheet"
			href="https://gyrocode.github.io/jquery-datatables-checkboxes/1.2.12/css/dataTables.checkboxes.css"
		/>
		<style>
			.recent-product-img {
				width: 50px;
				height: 50px;
				border-radius: 50%;
			}

			.recent-product-img img {
				width: 100%;
				height: 100%;
				padding: 2px;
				border-radius: 50%;
			}

			tbody tr td {
				text-align: center;
				vertical-align: middle;
			}

			.modal-content {
				background-image: radial-gradient(
						circle at 17% 1%,
						rgba(198, 198, 198, 0.03) 0,
						rgba(198, 198, 198, 0.03) 50%,
						rgba(42, 42, 42, 0.03) 50%,
						rgba(42, 42, 42, 0.03) 100%
					),
					radial-gradient(
						circle at 8% 81%,
						rgba(253, 253, 253, 0.03) 0,
						rgba(253, 253, 253, 0.03) 50%,
						rgba(36, 36, 36, 0.03) 50%,
						rgba(36, 36, 36, 0.03) 100%
					),
					radial-gradient(
						circle at 83% 29%,
						rgba(164, 164, 164, 0.03) 0,
						rgba(164, 164, 164, 0.03) 50%,
						rgba(60, 60, 60, 0.03) 50%,
						rgba(60, 60, 60, 0.03) 100%
					),
					radial-gradient(
						circle at 96% 62%,
						rgba(170, 170, 170, 0.03) 0,
						rgba(170, 170, 170, 0.03) 50%,
						rgba(169, 169, 169, 0.03) 50%,
						rgba(169, 169, 169, 0.03) 100%
					),
					linear-gradient(338deg, #028dd5, #05ac51);
			}

			#addModal .nav-tabs .nav-link .tab-close {
				display: none;
			}
			#addModal .nav-tabs .nav-link:hover .tab-close {
				display: block;
			}
		</style>
	</head>

	<body class="bg-theme bg-theme13">
		<!--wrapper-->
		<div class="wrapper">
			<!--sidebar wrapper -->
			<%- include('./partials/sidebar') %>
			<!--end sidebar wrapper -->
			<!--start header -->
			<%- include('./partials/header') %>
			<!--end header -->
			<!--start page wrapper -->
			<div class="page-wrapper">
				<div class="page-content">
					<!--breadcrumb-->
					<div class="page-breadcrumb d-none d-sm-flex align-items-center mb-3">
						<div class="breadcrumb-title pe-3">Episodes</div>
						<div class="ps-3">
							<nav aria-label="breadcrumb">
								<ol class="breadcrumb mb-0 p-0">
									<li class="breadcrumb-item">
										<a href="javascript:;"><i class="bx bx-home-alt"></i></a>
									</li>
									<li class="breadcrumb-item" aria-current="page">Episodes</li>
									<li class="breadcrumb-item active" aria-current="page">
										<%= `${filmInfo.originalName} (${filmInfo.year})`%>
									</li>
								</ol>
							</nav>
						</div>
					</div>
					<!--end breadcrumb-->
					<div class="card">
						<div class="card-body">
							<div class="d-flex justify-content-end mb-3">
								<button
									type="button"
									class="btn btn-outline-light px-2 me-1"
									data-bs-toggle="modal"
									data-bs-target="#addModal"
								>
									<i class="bx bx-plus-circle me-1"></i>Episodes
								</button>
								<button
									type="button"
									class="btn btn-outline-light px-2 me-1"
									id="btn-many-delete"
									data-bs-toggle="modal"
									data-bs-target="#deleteModal"
									disabled
								>
									<i class="bx bx-trash"></i>
									<span>Delete</span>
								</button>
							</div>
							<div class="table-responsive">
								<table id="tableEpisode" class="table table-striped table-bordered" style="width: 100%">
									<thead>
										<tr>
											<th></th>
											<th>ID</th>
											<th>Name</th>
											<th>Language</th>
											<th>Subtitle</th>
											<th>Created</th>
											<th>Updated</th>
											<th>Action</th>
										</tr>
									</thead>
									<tfoot>
										<tr>
											<th></th>
											<th>ID</th>
											<th>Name</th>
											<th>Language</th>
											<th>Subtitle</th>
											<th>Created</th>
											<th>Updated</th>
											<th>Action</th>
										</tr>
									</tfoot>
								</table>
							</div>
						</div>
					</div>
				</div>

				<!-- Modals -->
				<!-- Delete Modals -->
				<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title" id="deleteModalLabel">Delete Episode</h5>
								<button
									type="button"
									class="btn-close"
									data-bs-dismiss="modal"
									aria-label="Close"
								></button>
							</div>
							<div class="modal-body">
								<span class="modal-body-text"></span>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-primary text-white bg-gradient-burning btn-delete">
									Delete
								</button>
								<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
							</div>
						</div>
					</div>
				</div>
				<!-- Edit Modals -->
				<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
					<div class="modal-dialog modal-xl modal-dialog-scrollable">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title">Edit Member</h5>
								<button
									type="button"
									class="btn-close"
									data-bs-dismiss="modal"
									aria-label="Close"
								></button>
							</div>
							<div class="modal-body">
								<div class="card">
									<div class="card-body">
										<form class="row g-3">
											<div class="col-md-6 mb-3">
												<label class="form-label">User Name:</label>
												<input
													type="text"
													class="form-control"
													name="name"
													placeholder="User Name"
												/>
											</div>
											<div class="col-md-6 mb-3">
												<label class="form-label">Email:</label>
												<input
													type="email"
													class="form-control"
													name="email"
													placeholder="Mail"
												/>
											</div>
											<div class="col-md-5 mb-3">
												<label class="form-label">Address Avatar:</label>
												<input
													type="text"
													class="form-control"
													name="avatar"
													placeholder="Address Avatar"
												/>
											</div>
											<div class="col-md-5 mb-3">
												<label class="form-label">Reset Password:</label>
												<input
													type="text"
													class="form-control"
													name="pass"
													placeholder="Reset Password"
												/>
											</div>
											<div class="col-md-2 mb-3">
												<label class="form-label">Membership:</label>
												<select class="form-control" name="level">
													<option selected value="0">Admin</option>
													<option value="1">Poster</option>
													<option value="2">Member</option>
												</select>
											</div>
											<input name="user_id" style="display: none" />
										</form>
									</div>
								</div>
							</div>
							<div class="modal-footer">
								<button
									type="button"
									class="btn btn-primary text-white bg-gradient-blues btn-save"
									style="border-color: #fff"
								>
									Save changes
								</button>
								<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
							</div>
						</div>
					</div>
				</div>
				<!-- Add Modals -->
				<div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
					<div class="modal-dialog modal-fullscreen modal-dialog-scrollable">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title">Add Episodes</h5>
								<button
									type="button"
									class="btn-close"
									data-bs-dismiss="modal"
									aria-label="Close"
								></button>
							</div>
							<div class="modal-body">
								<div class="card">
									<div class="card-body">
										<ul class="nav nav-tabs" role="tablist">
											<li class="nav-item" role="presentation">
												<a
													class="nav-link active position-relative"
													data-bs-toggle="tab"
													href="#ep-form-1"
													role="tab"
													aria-selected="true"
												>
													<div class="d-flex align-items-center">
														<div class="tab-icon">
															<i class="bx bx-movie font-18 me-1"></i>
														</div>
														<div class="tab-title">Episode</div>
														<div
															class="tab-close position-absolute top-0 start-100 translate-middle badge border border-light rounded-circle bg-danger p-0"
															onclick="episodeUiAction.removeEpisodeTab(event)"
														>
															<i class="bx bx-x font-18"></i>
														</div>
													</div>
												</a>
											</li>
											<li class="nav-item" role="presentation">
												<a
													class="nav-link"
													href="#"
													aria-selected="false"
													onclick="episodeUiAction.moreEpisodeTab(event)"
												>
													<div class="d-flex align-items-center">
														<div class="tab-icon">
															<i class="bx bx-plus font-18 me-1"></i>
														</div>
														<div class="tab-title">More</div>
													</div>
												</a>
											</li>
										</ul>
										<div class="tab-content py-3">
											<div class="tab-pane fade show active" id="ep-form-1" role="tabpanel">
												<div class="card">
													<div class="card-body">
														<form class="row g-3">
															<div class="col-md-4 mb-3">
																<label class="form-label">Language:</label>
																<select class="form-select" name="language" required>
																	<% listLanguages.forEach((val) => { %>
																	<option value="<%=val%>"><%=val%></option>
																	<% }); %>
																</select>
															</div>
															<div class="col-md-8 mb-3">
																<label class="form-label">Message:</label>
																<input
																	type="text"
																	class="form-control"
																	name="message"
																	placeholder="Message"
																/>
															</div>
															<div class="col-md-4 mb-3">
																<label class="form-label">Name:</label>
																<input
																	type="text"
																	class="form-control"
																	name="name"
																	placeholder="Name"
																	required
																/>
															</div>
															<div class="col-md-8 mb-3">
																<label class="form-label">Subtitle:</label>
																<input
																	type="text"
																	class="form-control"
																	name="subtitle"
																	placeholder="Subtitle"
																/>
															</div>
															<div class="col-md-12 mb-3">
																<div
																	class="d-flex justify-content-between align-items-center mb-1"
																>
																	<label class="form-label font-13">Links:</label>
																	<button
																		type="button"
																		class="btn btn-outline-light btn-sm float-end"
																		onclick="episodeUiAction.moreLinkfield(event)"
																	>
																		<i class="bx bx-plus me-0"></i> More
																	</button>
																</div>
																<div class="links-fields">
																	<div class="d-flex gap-2 mb-1">
																		<input
																			type="text"
																			class="form-control"
																			name="links"
																			placeholder="Link"
																		/>
																		<button
																			type="button"
																			class="btn btn-outline-danger btn-sm"
																			onclick="episodeUiAction.removeLinkfield(event)"
																		>
																			<i class="bx bx-x me-0"></i>
																		</button>
																	</div>
																</div>
															</div>
														</form>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
							<div class="modal-footer">
								<button
									type="button"
									class="btn btn-primary text-white bg-gradient-blues btn-create"
									style="border-color: #fff"
								>
									Create
								</button>
								<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!--end page wrapper -->
			<!--start overlay-->
			<div class="overlay toggle-icon"></div>
			<!--end overlay-->
			<!--Start Back To Top Button-->
			<a href="javaScript:;" class="back-to-top"><i class="bx bxs-up-arrow-alt"></i></a>
			<!--End Back To Top Button-->
			<%- include('./partials/footer') %>
		</div>
		<!--end wrapper-->
		<!--start switcher-->
		<%- include('./partials/switcher') %>
		<!--end switcher-->
		<!-- Start Javascript Import -->
		<%- include('./partials/javascript-import') %>
		<script
			type="text/javascript"
			src="//gyrocode.github.io/jquery-datatables-checkboxes/1.2.12/js/dataTables.checkboxes.min.js"
		></script>
		<script>
			const episodeUiAction = {
				currentId: 1,
				initialUI: $('#addModal .modal-body .card-body').first().children().clone(),
				moreLinkfield: function (e) {
					e.preventDefault();
					const linksFields = e.target.closest('form').querySelector('.links-fields');
					$(linksFields).append(`<div class="d-flex gap-2 mb-1">
					<input type="text" class="form-control" name="links" placeholder="Link"/>
					<button type="button" class="btn btn-outline-danger btn-sm" onclick="episodeUiAction.removeLinkfield(event)"><i class="bx bx-x me-0"></i></button>
					</div>`);
				},
				removeLinkfield: function (e) {
					e.target.closest('div').remove();
				},
				moreEpisodeTab: function (e) {
					e.preventDefault();
					this.currentId++;
					const id = $('#addModal .nav-tabs').children().length;
					$(e.target.closest('li')).before(`<li class="nav-item" role="presentation">
												<a class="nav-link position-relative" data-bs-toggle="tab" href="#ep-form-${this.currentId}" role="tab" aria-selected="true">
													<div class="d-flex align-items-center">
														<div class="tab-icon"><i class="bx bx-movie font-18 me-1"></i></div>
														<div class="tab-title">Episode</div>
														<div class="tab-close position-absolute top-0 start-100 translate-middle badge border border-light rounded-circle bg-danger p-0" onclick="episodeUiAction.removeEpisodeTab(event)">
															<i class="bx bx-x font-18"></i>
														</div>
													</div>
												</a>
											</li>`);

					$('#addModal .tab-content')
						.append(`<div class="tab-pane fade show" id="ep-form-${this.currentId}" role="tabpanel">
												<div class="card">
													<div class="card-body">
														<form class="row g-3">
															<div class="col-md-4 mb-3">
																<label class="form-label">Language:</label>
																<select class="form-select" name="language" required>
																	<% listLanguages.forEach((val) => { %>
																	<option value="<%=val%>"><%=val%></option>
																	<% }); %>
																</select>
															</div>
															<div class="col-md-8 mb-3">
																<label class="form-label">Message:</label>
																<input type="text" class="form-control" name="message" placeholder="Message"/>
															</div>
															<div class="col-md-4 mb-3">
																<label class="form-label">Name:</label>
																<input type="text" class="form-control" name="name" placeholder="Name" required/>
															</div>
															<div class="col-md-8 mb-3">
																<label class="form-label">Subtitle:</label>
																<input type="text" class="form-control" name="subtitle" placeholder="Subtitle"/>
															</div>
															<div class="col-md-12 mb-3">
																<div class="d-flex justify-content-between align-items-center mb-1">
																	<label class="form-label font-13">Links:</label>
																	<button type="button" class="btn btn-outline-light btn-sm float-end" onclick="episodeUiAction.moreLinkfield(event)">
																		<i class="bx bx-plus me-0"></i> More
																	</button>
																</div>
																<div class="links-fields">
																	<div class="d-flex gap-2 mb-1">
																		<input type="text" class="form-control" name="links" placeholder="Link"/>
																		<button type="button" class="btn btn-outline-danger btn-sm" onclick="episodeUiAction.removeLinkfield(event)">
																			<i class="bx bx-x me-0"></i>
																		</button>
																	</div>
																</div>
															</div>
														</form>
													</div>
												</div>
											</div>`);
				},

				removeEpisodeTab: function (e) {
					const li = e.target.closest('li');
					const id = li.querySelector('a').getAttribute('href');
					li.remove();
					$(id).remove();
				},
				clear: function () {
					this.currentId = 1;
					$('#addModal .modal-body .card-body').children().remove();
					$('#addModal .modal-body .card-body').html(this.initialUI.clone());
				},
			};
		</script>
		<script>
			const FILM_ID = '<%=filmInfo._id%>';

			const dataTable = $('#tableEpisode').DataTable({
				scrollX: true,
				processing: true,
				serverSide: true,
				ajax: {
					url: '/admin/episodes/datatables_ajax/?filmId=' + FILM_ID,
					type: 'POST',
				},
				columns: [
					{ name: null },
					{ name: 'id' },
					{ name: 'name' },
					{ name: 'language' },
					{ name: 'subtitle' },
					{ name: 'createdAt' },
					{ name: 'updatedAt' },
					{ name: null },
				],
				columnDefs: [
					{
						orderable: false,
						targets: [4, 7],
					},
					{
						orderable: false,
						targets: 0,
						checkboxes: {
							selectRow: true,
						},
					},
				],
				select: {
					style: 'multi',
					selector: 'td:first-child > input[type="checkbox"], th:first-child > input[type="checkbox"]',
				},
				order: [[5, 'desc']],
			});

			$('#tableEpisode_filter input')
				.unbind()
				.bind('keyup', function (e) {
					if (e.keyCode == 13) dataTable.search(this.value).draw();
				});

			// disabled/enabled btn-many-delete
			dataTable
				.on('select', function (e, dt, type, indexes) {
					dataTable.rows('.selected').any()
						? $('#btn-many-delete').attr('disabled', false)
						: $('#btn-many-delete').attr('disabled', true);
				})
				.on('deselect', function (e, dt, type, indexes) {
					dataTable.rows('.selected').any()
						? $('#btn-many-delete').attr('disabled', false)
						: $('#btn-many-delete').attr('disabled', true);
				});

			// Handle create new Country
			const btnCreate = document.querySelector('#addModal .modal-footer .btn-create');
			if (btnCreate)
				btnCreate.onclick = function () {
					const forms = document.querySelectorAll('#addModal form');
					const dataForms = Array.prototype.map.bind(forms)((form) => {
						const linksFields = form.querySelectorAll('.links-fields input[name="links"]');
						const {
							0: { value: language },
							1: { value: message },
							2: { value: name },
							3: { value: subtitle },
						} = form;
						const links = Array.prototype.map.bind(linksFields)(({ value }) => value);

						return { language, message, name, subtitle, links };
					});

					$.ajax({
						type: 'POST',
						url: '/admin/episodes/create',
						data: { data: dataForms, filmId: FILM_ID },
					})
						.done((res) => {
							episodeUiAction.clear();
							$('#addModal').modal('hide');
							dataTable.ajax.reload(null, false);
							notyf.success(res.message);
						})
						.fail(({ responseJSON }) => {
							episodeUiAction.clear();
							$('#addModal').modal('hide');
							notyf.error(responseJSON.message);
						});
				};

			function fillDataToDeleteForm(name, id) {
				document.querySelector(
					'#deleteModal .modal-body-text',
				).innerHTML = `Are you sure want delete episode "<span style="font-weight: 500; color: #fff">${name}</span>"?`;
				document.querySelector('#deleteModal .modal-footer .btn-delete').onclick = function () {
					$.ajax({
						type: 'DELETE',
						url: '/admin/episodes/delete/' + id,
						data: { filmId: FILM_ID },
					})
						.done((res) => {
							$('#deleteModal').modal('hide');
							notyf.success(res.message);
							dataTable.ajax.reload(null, false);
						})
						.fail(({ responseJSON }) => {
							$('#deleteModal').modal('hide');
							notyf.error(responseJSON.message);
						});
				};
			}

			// Handle many delete & many delete permanently
			const btnManyDelete = document.getElementById('btn-many-delete');
			if (btnManyDelete)
				btnManyDelete.onclick = function () {
					const selected = dataTable.columns().checkboxes.selected()[0];
					document.querySelector(
						'#deleteModal .modal-body-text',
					).innerHTML = `Are you sure want delete these ${selected.length} episodes?`;
					document.querySelector('#deleteModal .modal-footer .btn-delete').onclick = function () {
						$.ajax({
							url: '/admin/episodes/delete-many/',
							type: 'delete',
							data: { episodeIds: selected, filmId: FILM_ID },
						})
							.done((res) => {
								$('#deleteModal').modal('hide');
								notyf.success(res.message);
								dataTable.ajax.reload(null, false);
								dataTable.columns().checkboxes.deselectAll();
							})
							.fail(({ responseJSON }) => {
								$('#deleteModal').modal('hide');
								notyf.error(responseJSON.message);
								dataTable.columns().checkboxes.deselectAll();
							});
					};
				};
		</script>
		<!-- End Javascript Import -->
	</body>
</html>
