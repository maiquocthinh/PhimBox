<!DOCTYPE html>
<html lang="en">
	<head>
		<%- include('./partials/head') %>
		<style>
			.recent-product-img {
				width: 50px;
				height: 50px;
				border-radius: 50%;
			}

			.recent-product-img img {
				width: 100%;
				height: 100%;
				padding: 2px;
				border-radius: 50%;
			}

			tbody tr td {
				text-align: center;
				vertical-align: middle;
			}

			.modal-content {
				background-image: radial-gradient(
						circle at 17% 1%,
						rgba(198, 198, 198, 0.03) 0,
						rgba(198, 198, 198, 0.03) 50%,
						rgba(42, 42, 42, 0.03) 50%,
						rgba(42, 42, 42, 0.03) 100%
					),
					radial-gradient(
						circle at 8% 81%,
						rgba(253, 253, 253, 0.03) 0,
						rgba(253, 253, 253, 0.03) 50%,
						rgba(36, 36, 36, 0.03) 50%,
						rgba(36, 36, 36, 0.03) 100%
					),
					radial-gradient(
						circle at 83% 29%,
						rgba(164, 164, 164, 0.03) 0,
						rgba(164, 164, 164, 0.03) 50%,
						rgba(60, 60, 60, 0.03) 50%,
						rgba(60, 60, 60, 0.03) 100%
					),
					radial-gradient(
						circle at 96% 62%,
						rgba(170, 170, 170, 0.03) 0,
						rgba(170, 170, 170, 0.03) 50%,
						rgba(169, 169, 169, 0.03) 50%,
						rgba(169, 169, 169, 0.03) 100%
					),
					linear-gradient(338deg, #028dd5, #05ac51);
			}
		</style>
	</head>

	<body class="bg-theme bg-theme13">
		<!--wrapper-->
		<div class="wrapper">
			<!--sidebar wrapper -->
			<%- include('./partials/sidebar') %>
			<!--end sidebar wrapper -->
			<!--start header -->
			<%- include('./partials/header') %>
			<!--end header -->
			<!--start page wrapper -->
			<div class="page-wrapper">
				<div class="page-content">
					<!--breadcrumb-->
					<div class="page-breadcrumb d-none d-sm-flex align-items-center mb-3">
						<div class="breadcrumb-title pe-3">Users</div>
						<div class="ps-3">
							<nav aria-label="breadcrumb">
								<ol class="breadcrumb mb-0 p-0">
									<li class="breadcrumb-item">
										<a href="javascript:;"><i class="bx bx-home-alt"></i></a>
									</li>
									<li class="breadcrumb-item active" aria-current="page">Users</li>
								</ol>
							</nav>
						</div>
					</div>
					<!--end breadcrumb-->
					<div class="card">
						<div class="card-body">
							<div class="d-flex justify-content-end mb-3">
								<button
									type="button"
									class="btn btn-outline-light px-2 me-1"
									data-bs-toggle="modal"
									data-bs-target="#addModal"
								>
									<i class="bx bx-plus-circle me-1"></i>User
								</button>
								<button type="button" id="btn-trash" class="btn btn-outline-light px-2">
									<i class="bx bx-trash me-1"></i><span>Trash</span>
								</button>
							</div>
							<div class="table-responsive">
								<table id="tableUser" class="table table-striped table-bordered" style="width: 100%">
									<thead>
										<tr>
											<th>ID</th>
											<th>Name</th>
											<th>Mail</th>
											<th>Permission</th>
											<th>Uploaded</th>
											<th>Created</th>
											<th>Updated</th>
											<th>Action</th>
										</tr>
									</thead>
									<tfoot>
										<tr>
											<th>ID</th>
											<th>Name</th>
											<th>Mail</th>
											<th>Permission</th>
											<th>Uploaded</th>
											<th>Created</th>
											<th>Updated</th>
											<th>Action</th>
										</tr>
									</tfoot>
								</table>
							</div>
						</div>
					</div>
				</div>

				<!-- Modals -->
				<!-- Delete Modals -->
				<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title" id="deleteModalLabel">Delete User</h5>
								<button
									type="button"
									class="btn-close"
									data-bs-dismiss="modal"
									aria-label="Close"
								></button>
							</div>
							<div class="modal-body">
								Are you sure want delete user "<span
									id="user-name-text"
									style="font-weight: 500; color: #fff"
								></span
								>"<span id="permanently-text" class="d-none text-capitalize"> permanently</span>?
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-primary text-white bg-gradient-burning btn-delete">
									Delete
								</button>
								<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
							</div>
						</div>
					</div>
				</div>
				<!-- Edit Modals -->
				<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
					<div class="modal-dialog modal-xl modal-dialog-scrollable">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title">Edit Member</h5>
								<button
									type="button"
									class="btn-close"
									data-bs-dismiss="modal"
									aria-label="Close"
								></button>
							</div>
							<div class="modal-body">
								<div class="card">
									<div class="card-body">
										<form class="row g-3">
											<div class="col-md-6 mb-3">
												<label class="form-label">User Name:</label>
												<input
													type="text"
													class="form-control"
													name="name"
													placeholder="User Name"
												/>
											</div>
											<div class="col-md-6 mb-3">
												<label class="form-label">Email:</label>
												<input
													type="email"
													class="form-control"
													name="email"
													placeholder="Mail"
												/>
											</div>
											<div class="col-md-5 mb-3">
												<label class="form-label">Address Avatar:</label>
												<input
													type="text"
													class="form-control"
													name="avatar"
													placeholder="Address Avatar"
												/>
											</div>
											<div class="col-md-5 mb-3">
												<label class="form-label">Reset Password:</label>
												<input
													type="text"
													class="form-control"
													name="pass"
													placeholder="Reset Password"
												/>
											</div>
											<div class="col-md-2 mb-3">
												<label class="form-label">Membership:</label>
												<select class="form-control" name="level">
													<option selected value="0">Admin</option>
													<option value="1">Poster</option>
													<option value="2">Member</option>
												</select>
											</div>
											<input name="user_id" style="display: none" />
										</form>
									</div>
								</div>
							</div>
							<div class="modal-footer">
								<button
									type="button"
									class="btn btn-primary text-white bg-gradient-blues btn-save"
									style="border-color: #fff"
								>
									Save changes
								</button>
								<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
							</div>
						</div>
					</div>
				</div>
				<!-- Add Modals -->
				<div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
					<div class="modal-dialog modal-xl modal-dialog-scrollable">
						<div class="modal-content">
							<div class="modal-header">
								<h5 class="modal-title">Add Member</h5>
								<button
									type="button"
									class="btn-close"
									data-bs-dismiss="modal"
									aria-label="Close"
								></button>
							</div>
							<div class="modal-body">
								<div class="card">
									<div class="card-body">
										<form class="row g-3">
											<div class="col-md-6 mb-3">
												<label class="form-label">User Name:</label>
												<input
													type="text"
													class="form-control"
													name="name"
													placeholder="User Name"
												/>
											</div>
											<div class="col-md-6 mb-3">
												<label class="form-label">Email:</label>
												<input
													type="email"
													class="form-control"
													name="email"
													placeholder="Mail"
												/>
											</div>
											<div class="col-md-5 mb-3">
												<label class="form-label">Address Avatar:</label>
												<input
													type="text"
													class="form-control"
													name="avatar"
													placeholder="Address Avatar"
												/>
											</div>
											<div class="col-md-5 mb-3">
												<label class="form-label">Password:</label>
												<input
													type="text"
													class="form-control"
													name="password"
													placeholder="Password"
												/>
											</div>
											<div class="col-md-2 mb-3">
												<label class="form-label">Membership:</label>
												<select class="form-control" name="level">
													<option selected value="0">Admin</option>
													<option value="1">Poster</option>
													<option value="2">Member</option>
												</select>
											</div>
										</form>
									</div>
								</div>
							</div>
							<div class="modal-footer">
								<button
									type="button"
									class="btn btn-primary text-white bg-gradient-blues btn-create"
									style="border-color: #fff"
								>
									Create
								</button>
								<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!--end page wrapper -->
			<!--start overlay-->
			<div class="overlay toggle-icon"></div>
			<!--end overlay-->
			<!--Start Back To Top Button-->
			<a href="javaScript:;" class="back-to-top"><i class="bx bxs-up-arrow-alt"></i></a>
			<!--End Back To Top Button-->
			<footer class="page-footer">
				<p class="mb-0">Copyright Â© 2021. All right reserved.</p>
			</footer>
		</div>
		<!--end wrapper-->
		<!-- Start Javascript Import -->
		<%- include('./partials/javascript-import') %>
		<script>
			const dataTable = $('#tableUser').DataTable({
				scrollX: true,
				processing: true,
				serverSide: true,
				ajax: {
					url: '/admin/users/datatables_ajax/',
					type: 'POST',
				},
				columns: [
					{ name: 'id' },
					{ name: 'name' },
					{ name: 'mail' },
					{ name: 'level' },
					{ name: 'null' },
					{ name: 'createdAt' },
					{ name: 'updatedAt' },
					{ name: null },
				],
				columnDefs: [
					{
						orderable: false,
						targets: [6],
					},
				],
			});
			$('#tableUser_filter input').unbind();
			$('#tableUser_filter input').bind('keyup', function (e) {
				if (e.keyCode == 13) {
					dataTable.search(this.value).draw();
				}
			});

			// Handle create new Country
			const btnSave = document.querySelector('#addModal .modal-footer .btn-create');
			btnSave.onclick = function () {
				const formCreate = document.querySelector('#addModal form');
				const dataForm = Object.fromEntries(new FormData(formCreate));
				$.ajax({
					type: 'POST',
					url: '/admin/users/create',
					data: dataForm,
				}).done((res) => {
					formCreate.reset();
					$('#addModal').modal('hide');
					dataTable.ajax.reload(null, false);
				});
			};

			// Fill name, id of country to delete form
			function fillDataToDeleteForm(name, id) {
        document.querySelector('#permanently-text').classList.add('d-none');
				document.querySelector('#user-name-text').textContent = name;
				document.querySelector('#deleteModal .modal-footer .btn-delete').onclick = function () {
					$.ajax({
						type: 'DELETE',
						url: '/admin/users/delete/' + id,
					}).done(() => {
						$('#deleteModal').modal('hide');
						dataTable.ajax.reload(null, false);
					});
				};
			}

      // Fill name, id of film to modal delete
			function fillDataToDeletePermanentlyForm(name, id) {
				document.querySelector('#permanently-text').classList.remove('d-none');
				document.querySelector('#user-name-text').textContent = name;
				document.querySelector('#deleteModal .modal-footer .btn-delete').onclick = function () {
					$.ajax({
						type: 'DELETE',
						url: '/admin/users/destroy/' + id,
					}).done(() => {
						$('#deleteModal').modal('hide');
						dataTable.ajax.reload(null, false);
					});
				};
			}

			// Fill data of country to edit form
			async function fillDataToEditForm(id) {
				const dataUser = await $.ajax({
					url: '/admin/users/read/' + id,
					type: 'GET',
				});
				const formEdit = document.querySelector('#editModal form');
				formEdit.querySelector('input[name="name"]').value = dataUser.name;
				formEdit.querySelector('input[name="email"]').value = dataUser.email;
				formEdit.querySelector('input[name="avatar"]').value = dataUser.avatar;
				formEdit.querySelector('select[name="level"]').value = dataUser.level;
				formEdit.querySelector('input[name="user_id"]').value = dataUser._id;
			}

			// Handle submit update
			const btnSaveUser = document.querySelector('#editModal .modal-footer .btn-save');
			if (btnSaveUser)
				btnSaveUser.onclick = function () {
					const formEdit = document.querySelector('#editModal form');
					const { user_id: userId, ...dataForm } = Object.fromEntries(new FormData(formEdit));
					$.ajax({
						type: 'PATCH',
						url: '/admin/users/update/' + userId,
						data: dataForm,
					}).done(() => {
						$('#editModal').modal('hide');
						dataTable.ajax.reload(null, false);
					});
				};

      // Hnalde resotre user
      function restoreUser(id) {
      $.ajax({
        type: 'PATCH',
        url: '/admin/users/restore/' + id,
      }).done(() => {
        dataTable.ajax.reload(null, false);
      });
    }

    // Handle btn trash onclick
			const btnTrash = document.getElementById('btn-trash');
			if (btnTrash)
				btnTrash.onclick = function () {
					const btnTrashText = btnTrash.querySelector('span');
					const deleted = btnTrashText.innerText === 'Trash';
					btnTrashText.innerText = deleted ? 'All List' : 'Trash';
					deleted
						? dataTable.ajax.url('/admin/users/datatables_ajax/?deleted=true').load()
						: dataTable.ajax.url('/admin/users/datatables_ajax/').load();
				};

		</script>
		<!-- End Javascript Import -->
	</body>
</html>
